<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Deposit Flow Demo</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#071026 0%, #081427 100%);color:#e6eef6;display:flex;align-items:center;justify-content:center;padding:32px}
    .card{width:980px;max-width:100%;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 24px rgba(2,6,23,0.6)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{font-size:18px;margin:0}
    p.lead{color:var(--muted);margin:4px 0 0}
    .controls{display:flex;gap:12px;margin:16px 0}
    button{background:var(--accent);border:0;padding:10px 14px;border-radius:8px;color:#022;cursor:pointer;font-weight:600}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(0deg,rgba(2,6,23,0.6),rgba(2,6,23,0.6))}
    .modal.show{display:flex}
    .sheet{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;width:540px;max-width:95%}
    .row{display:flex;gap:12px;align-items:center}
    select,input{background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:inherit;padding:8px;border-radius:8px}
    .address-box{background:#031423;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);word-break:break-all}
    .small{font-size:13px;color:var(--muted)}
    .copy{cursor:pointer;padding:6px 10px;border-radius:8px;border:0}
    .qr{width:160px;height:160px;background:#071428;border-radius:8px;display:flex;align-items:center;justify-content:center}
    .status{margin-top:12px;padding:10px;border-radius:8px;background:rgba(6,182,212,0.06);color:var(--accent)}
    .history{margin-top:14px;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px}
    .muted{color:var(--muted)}
    footer{margin-top:18px;display:flex;gap:10px;justify-content:flex-end}
    .pill{background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:999px;font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="card">
    <header>
      <div>
        <h1>Wallet — Deposit</h1>
        <p class="lead">Click Deposit to generate an invoice and get the address / QR code.</p>
      </div>
      <div class="pill">Demo — replace polling with real explorer APIs</div>
    </header><div class="controls">
  <select id="networkSelector">
    <option value="ETH">Ethereum (ETH)</option>
    <option value="BTC">Bitcoin (BTC)</option>
    <option value="BNB">BNB Smart Chain</option>
    <option value="USDT_TRON">USDT (TRON)</option>
  </select>

  <button id="depositBtn">Deposit</button>
  <button class="btn-ghost" id="viewHistory">View Local Deposit History</button>
</div>

<div id="hint" class="muted">Supported networks: ETH, BTC, BNB, USDT_TRON</div>

<div id="modal" class="modal" role="dialog" aria-hidden="true">
  <div class="sheet" role="document">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div>
        <strong id="modalTitle">Deposit</strong>
        <div class="small">Follow the instructions below — do NOT send tokens to the wrong chain.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="invoiceTag" class="pill">INVOICE #—</div>
        <button id="closeModal" class="btn-ghost">Close</button>
      </div>
    </div>

    <div style="display:flex;gap:16px">
      <div style="flex:1">
        <div class="small">Network</div>
        <div style="margin:6px 0 12px"> <strong id="selectedNetwork"></strong></div>

        <div class="small">Deposit address</div>
        <div class="address-box" id="addressBox"></div>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="copyAddress" class="copy">Copy address</button>
          <button id="openExplorer" class="copy btn-ghost">Open Explorer</button>
          <button id="iPaid" class="copy">I paid — check</button>
        </div>

        <div id="depositStatus" class="status" style="display:none"></div>

        <div class="history" id="instructions">
          <div class="small"><strong>Steps</strong></div>
          <ol style="margin:8px 0 0;padding-left:20px;color:var(--muted)">
            <li>Send exactly the amount shown in your external wallet (if your flow uses exact amounts).</li>
            <li>Ensure the network selected matches the token chain (e.g., USDT on TRON requires TRON network).</li>
            <li>Use the invoice id for support if funds don't arrive.</li>
          </ol>
        </div>

      </div>

      <div style="width:180px;text-align:center">
        <div class="qr" id="qrContainer">QR</div>
        <div class="small" style="margin-top:8px">Scan to copy address</div>
        <div class="small muted" style="margin-top:8px">Amount to send (optional): <strong id="amountToSend">—</strong></div>
      </div>
    </div>

    <footer>
      <button id="saveLocal" class="btn-ghost">Save to local</button>
      <button id="forceCheck" class="copy">Force check now</button>
    </footer>
  </div>
</div>

<pre id="historyDump" style="display:none;background:#071428;padding:12px;border-radius:8px;margin-top:12px;white-space:pre-wrap"></pre>

  </div><script>
// === Configuration (replace addresses or add memo requirements) ===
const addresses = {
  ETH: "0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130",
  BTC: "bc1qv4fffwt8ux3k33n2dms5cdvuh6suc0gtfevxzu",
  BNB: "0xB36EDa1ffC696FFba07D4Be5cd249FE5E0118130",
  USDT_TRON: "TSt7yoNwGYRbtMMfkSAHE6dPs1cd9rxcco",
};

// === UI references ===
const depositBtn = document.getElementById('depositBtn');
const modal = document.getElementById('modal');
const closeModal = document.getElementById('closeModal');
const selectedNetworkEl = document.getElementById('selectedNetwork');
const addressBox = document.getElementById('addressBox');
const copyAddressBtn = document.getElementById('copyAddress');
const qrContainer = document.getElementById('qrContainer');
const invoiceTag = document.getElementById('invoiceTag');
const networkSelector = document.getElementById('networkSelector');
const depositStatus = document.getElementById('depositStatus');
const viewHistory = document.getElementById('viewHistory');
const historyDump = document.getElementById('historyDump');
const iPaidBtn = document.getElementById('iPaid');
const forceCheck = document.getElementById('forceCheck');
const openExplorer = document.getElementById('openExplorer');
const amountToSendEl = document.getElementById('amountToSend');
const saveLocal = document.getElementById('saveLocal');

// === Helpers ===
function uuid() {
  // simple unique id for invoice
  return 'inv-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
}

function showModal() { modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); }
function hideModal() { modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

function formatExplorerUrl(network, address) {
  // Placeholder URLs — replace with your explorers or APIs
  if (network === 'ETH' || network === 'BNB') return `https://etherscan.io/address/${address}`;
  if (network === 'BTC') return `https://www.blockchain.com/btc/address/${address}`;
  if (network === 'USDT_TRON') return `https://tronscan.org/#/address/${address}`;
  return '#';
}

function renderQRCode(text) {
  // use a tiny client-side approach using Google Chart (simple and reliable for demos)
  qrContainer.innerHTML = '';
  const img = document.createElement('img');
  img.alt = 'QR code';
  img.width = 160; img.height = 160;
  img.src = `https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=${encodeURIComponent(text)}`;
  qrContainer.appendChild(img);
}

function saveDepositRecord(record) {
  const key = 'deposit_records_v1';
  const cur = JSON.parse(localStorage.getItem(key) || '[]');
  cur.unshift(record);
  localStorage.setItem(key, JSON.stringify(cur.slice(0,50)));
}

function loadDepositRecords() {
  return JSON.parse(localStorage.getItem('deposit_records_v1') || '[]');
}

function showHistory() {
  const rows = loadDepositRecords();
  historyDump.style.display = rows.length? 'block':'none';
  historyDump.textContent = JSON.stringify(rows, null, 2);
}

// === Deposit flow ===
let currentInvoice = null;

depositBtn.addEventListener('click', () => {
  const network = networkSelector.value;
  // Generate invoice and open modal
  currentInvoice = {
    id: uuid(),
    network,
    address: addresses[network] || 'UNKNOWN',
    createdAt: new Date().toISOString(),
    amount: null, // optional — fill if you want user to send exact amount
    status: 'PENDING'
  };

  selectedNetworkEl.textContent = network;
  addressBox.textContent = currentInvoice.address;
  invoiceTag.textContent = `INVOICE ${currentInvoice.id}`;
  depositStatus.style.display = 'none';
  amountToSendEl.textContent = currentInvoice.amount? currentInvoice.amount:'—';
  renderQRCode(currentInvoice.address);
  showModal();
});

closeModal.addEventListener('click', hideModal);

copyAddressBtn.addEventListener('click', async () => {
  try {
    await navigator.clipboard.writeText(addressBox.textContent.trim());
    depositStatus.style.display = 'block';
    depositStatus.textContent = 'Address copied to clipboard.';
    setTimeout(()=>depositStatus.style.display='none',2000);
  } catch(e){
    depositStatus.style.display = 'block';
    depositStatus.textContent = 'Copy failed — select and copy manually.';
    setTimeout(()=>depositStatus.style.display='none',3000);
  }
});

openExplorer.addEventListener('click', () => {
  if (!currentInvoice) return;
  const url = formatExplorerUrl(currentInvoice.network, currentInvoice.address);
  window.open(url,'_blank');
});

saveLocal.addEventListener('click', () => {
  if (!currentInvoice) return;
  saveDepositRecord({...currentInvoice, savedAt:new Date().toISOString()});
  depositStatus.style.display = 'block';
  depositStatus.textContent = 'Invoice saved to local history.';
  setTimeout(()=>depositStatus.style.display='none',2000);
});

viewHistory.addEventListener('click', ()=>{
  showHistory();
  historyDump.scrollIntoView({behavior:'smooth'});
});

// === Checking deposits ===
// NOTE: You must replace `mockCheckDeposit` with real calls to block explorers (Etherscan, Blockchain.com, Tronscan, etc.)
// For high reliability, query a reliable node or indexing service and match by tx hash OR incoming transfers to the address for that invoice amount.

async function mockCheckDeposit(network, address, invoiceId) {
  // DEMO: simulate a deposit with a 20% chance of success per check
  await new Promise(r=>setTimeout(r,800));
  const success = Math.random() < 0.2;
  if (success) return {found:true, txHash: '0x'+Math.random().toString(36).slice(2,12), value:'0.5'};
  return {found:false};
}

async function checkDepositAndUpdate() {
  if (!currentInvoice) return;
  depositStatus.style.display = 'block';
  depositStatus.textContent = 'Checking for deposit transactions...';

  // Replace mockCheckDeposit with your explorer API call
  const result = await mockCheckDeposit(currentInvoice.network, currentInvoice.address, currentInvoice.id);
  if (result && result.found) {
    currentInvoice.status = 'COMPLETED';
    currentInvoice.txHash = result.txHash;
    currentInvoice.amount = result.value || currentInvoice.amount;
    depositStatus.textContent = `Deposit detected — TX ${result.txHash}`;
    saveDepositRecord({...currentInvoice, completedAt:new Date().toISOString()});
  } else {
    depositStatus.textContent = 'No deposit found yet. Try again or wait a few minutes.';
  }
}

forceCheck.addEventListener('click', checkDepositAndUpdate);

iPaidBtn.addEventListener('click', checkDepositAndUpdate);

// === Optional: auto-polling while modal open (disabled by default) ===
let pollHandle = null;
modal.addEventListener('transitionstart', ()=>{});
modal.addEventListener('click', (e)=>{ if (e.target === modal) hideModal(); });

// If you'd like automatic polling while the modal is open, uncomment below:
/*
modal.addEventListener('transitionrun', ()=>{
  if (modal.classList.contains('show')) {
    pollHandle = setInterval(checkDepositAndUpdate, 15000);
  } else {
    clearInterval(pollHandle);
  }
});
*/

// === On load show any stored history ===
showHistory();

</script></body>
</html>

